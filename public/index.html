<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <script>
            const worker = new Worker('./db-worker.js', { type: 'module' });

            let dbInitialized = false;
            let done = false
            let count = 0

            // Handle messages from the worker
            worker.onmessage = (event) => {
                const result = event.data;
                if (result.error) {
                    console.error(`Error: ${result.error}`);
                } else {
                    console.log(`Result:`, result);
                    console.log('count', count++);
                    

                    // After database connection is created, create the users table
                    if (result?.message?.includes('Database created')) {
                        dbInitialized = true;
                        console.log('dbInitialized', dbInitialized);
                    }
                }
            };

            // Send message to worker to create a database connection
            worker.postMessage({
                action: 'createDBConnection',
                dbName: 'test.db',
            });

            // Function to create the users table from the main thread
            function createUsersTable() {
                const createTableSQL = `
                    CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        age INTEGER NOT NULL
                    );
                `;

                worker.postMessage({
                    action: 'executeRawQuery',
                    dbName: 'test.db',
                    sql: createTableSQL,
                });
            }

            // Function to run queries after table creation
            function runQueries() {
                if (!dbInitialized) {
                    console.warn('Users table not created yet.');
                    return;
                }

                // Example to run a raw query
                const sql = 'SELECT * FROM users';
                worker.postMessage({
                    action: 'executeRawQuery',
                    dbName: 'test.db',
                    sql,
                });

                // Example to run multiple queries
                const queries = [
                    "INSERT INTO users(name, age) VALUES('John Doe', 30)",
                    "INSERT INTO users(name, age) VALUES('Jane Doe', 25)",
                ];
                worker.postMessage({
                    action: 'executeQueries',
                    dbName: 'test.db',
                    queries,
                    rollbackOnError: true,
                });
            }

            window.createUsersTable = createUsersTable;
            window.runQueries = runQueries;
        </script>
    </body>
</html>
